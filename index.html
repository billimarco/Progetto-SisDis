<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="X-UA-Compatible" content="ie=edge">
  <title>Snap4City Editor</title>
</head>

<body>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/jerosoler/Drawflow@0.0.48/dist/drawflow.min.css">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.1/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-4bw+/aepP/YC94hEpVNVgiZdgIC5+VKNBQNGCHeKRQN+PtmoHDEXuppvnDJzQIu9" crossorigin="anonymous">
  <link rel="stylesheet" type="text/css" href="editor.css" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.13.0/css/all.min.css" integrity="sha256-h20CPZ0QyXlBuAw7A+KluUYx/3pK+c7lYEpqLTlxjYQ=" crossorigin="anonymous" />
  <link href="https://fonts.googleapis.com/css2?family=Roboto&display=swap" rel="stylesheet">
  
  <script src="https://cdn.jsdelivr.net/gh/jerosoler/Drawflow/dist/drawflow.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.13.0/js/all.min.js" integrity="sha256-KzZiKy0DWYsnwMF+X1DvQngQ2/FxF7MF3Ff72XcpuPs=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@9"></script>
  <script src="https://unpkg.com/micromodal/dist/micromodal.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.1/dist/js/bootstrap.bundle.min.js" integrity="sha384-HwwvtgBNo3bZJJLYd8oVXjrBZt8cqVSpeBNS5n7C8IVInixGAoxmnlMuBnhbgrkm" crossorigin="anonymous"></script>


  <header>
    <h2>Snap4City Editor</h2>
  </header>
  <div class="wrapper">
    <div class="col">
      <div class="drag-drawflow" draggable="true" ondragstart="drag(event)" data-node="RadarSeries">
        <span>RadarSeries</span>
      </div>
      <div class="drag-drawflow" draggable="true" ondragstart="drag(event)" data-node="TimeTrend">
        <span>TimeTrend</span>
      </div>
      <div class="drag-drawflow" draggable="true" ondragstart="drag(event)" data-node="CurvedLineSeries">
        <span>CurvedLineSeries</span>
      </div>
      <div class="drag-drawflow" draggable="true" ondragstart="drag(event)" data-node="PieChart">
        <span>PieChart</span>
      </div>
      <div class="drag-drawflow" draggable="true" ondragstart="drag(event)" data-node="BarSeries">
        <span>BarSeries</span>
      </div>
      <div class="drag-drawflow" draggable="true" ondragstart="drag(event)" data-node="Map">
        <span>Map</span>
      </div>
      <div class="drag-drawflow" draggable="true" ondragstart="drag(event)" data-node="Speedometer">
        <span>Speedometer</span>
      </div>
      <div class="drag-drawflow" draggable="true" ondragstart="drag(event)" data-node="GaugeChart">
        <span>GaugeChart</span>
      </div>
      <div class="drag-drawflow" draggable="true" ondragstart="drag(event)" data-node="Knob">
        <span>Knob</span>
      </div>
      <div class="drag-drawflow" draggable="true" ondragstart="drag(event)" data-node="NumericKeyboard">
        <span>NumericKeyboard</span>
      </div>
      <div class="drag-drawflow" draggable="true" ondragstart="drag(event)" data-node="SingleContent">
        <span>SingleContent</span>
      </div>
      <div class="drag-drawflow" draggable="true" ondragstart="drag(event)" data-node="ExternalContent">
        <span>ExternalContent</span>
      </div>
      <div class="drag-drawflow" draggable="true" ondragstart="drag(event)" data-node="Table">
        <span>Table</span>
      </div>
      <div class="drag-drawflow" draggable="true" ondragstart="drag(event)" data-node="DeviceTable">
        <span>DeviceTable</span>
      </div>
      <div class="drag-drawflow" draggable="true" ondragstart="drag(event)" data-node="EventTable">
        <span>EventTable</span>
      </div>
      <div class="drag-drawflow" draggable="true" ondragstart="drag(event)" data-node="Button">
        <span>Button</span>
      </div>
      <div class="drag-drawflow" draggable="true" ondragstart="drag(event)" data-node="OnOffButton">
        <span>OnOffButton</span>
      </div>
      <div class="drag-drawflow" draggable="true" ondragstart="drag(event)" data-node="ImpulseButton">
        <span>ImpulseButton</span>
      </div>
    </div>

    <div class="col-right">
      <div id="drawflow" ondrop="drop(event)" ondragover="allowDrop(event)">

        <div class="btn-export" onclick="Swal.fire({ title: 'Export',
        html: '<pre><code>'+JSON.stringify(editor.export(), null,4)+'</code></pre>'
        })">Export</div>
        <div class="btn-clear" onclick="editor.clearModuleSelected()">Clear</div>
        <div class="btn-lock">
          <i id="lock" class="fas fa-lock" onclick="editor.editor_mode='fixed'; changeMode('lock');"></i>
          <i id="unlock" class="fas fa-lock-open" onclick="editor.editor_mode='edit'; changeMode('unlock');"
            style="display:none;"></i>
        </div>
        <div class="bar-zoom">
          <i class="fas fa-search-minus" onclick="editor.zoom_out()"></i>
          <i class="fas fa-search" onclick="editor.zoom_reset()"></i>
          <i class="fas fa-search-plus" onclick="editor.zoom_in()"></i>
        </div>
      </div>
    </div>
  </div>

  <script>
    
    //IMPORTANT for acceding some data of the node for update, like the HTML or others, we need to use <--editor.drawflow.drawflow[module].data[id]-->.

    var df = document.getElementById("drawflow");
    const editor = new Drawflow(df);
    editor.reroute = false;
    editor.reroute_fix_curvature = true;
    editor.force_first_input = false;
    const dataToImport = { "drawflow": { "Home": { "data": {"1": { "id": 1, "name": "legenda", "data": {}, "class": "legenda", "html": "\n    <div>\n      <div class=\"title-box\">Legenda</div>\n      <div class=\"box\">\n   üî¥ List of SURI #e81224<br>\n   üü¢ Time Interval #16c60c<br>\n   üîµ SURI #0078d7<br>\n   üü° Timestamp #fff100<br>\n  üü† Action #f7630c<br>\n  üü£ GPS Coordinates #886ce4<br>\n   üü§#8e562e<br>\n   ‚ö´#383838<br>\n   ‚ö™None #f2f2f2<br>\n   <p><b><u>Shortkeys:</u></b></p>\n        <p>üéπ <b>Delete</b> for remove selected<br>\n        üí† Mouse Left Click == Move<br>\n        ‚ùå Mouse Right == Delete Option<br>\n        üîç Ctrl + Wheel == Zoom<br>\n        üì± Mobile support<br>\n        ...</p>\n      </div>\n    </div>\n    </div>", "typenode": false, "inputs": {}, "outputs": {}, "pos_x": 50, "pos_y": 50 }}}}}
    editor.start();
    editor.import(dataToImport);

    var port_types = [
        {"name":"None","color": "#f2f2f2","possible_links":[]},
        {"name":"ListSURI","color": "#e81224","possible_links":[]},
        {"name":"time_interval","color": "#16c60c","possible_links":[]},
        {"name":"SURI","color": "#0078d7","possible_links":[]},
        {"name":"timestamp","color": "#fff100","possible_links":[]},
        {"name":"action","color": "#f7630c","possible_links":[]},
        {"name":"GPS_coordinates","color": "#886ce4","possible_links":[]}];

    var trigger_types = [
        {"id": 0,"type": "", "widgets_typologies_which_can_perform_it":["RadarSeries"], "target_widget":"", "possible_target_widgets_typologies":[], "output_types": port_types[0], "output_id": 0, "type_others": {"other_html":"<div></div>"}},
        {"id": 0,"type": "show...", "widgets_typologies_which_can_perform_it":["RadarSeries"], "target_widget":"", "possible_target_widgets_typologies":["RadarSeries","TimeTrend"], "output_types": port_types[0], "output_id": 0, "type_others": {"other_html":"<div></div>"}},
        {"id": 0,"type": "do...", "widgets_typologies_which_can_perform_it":["RadarSeries"], "target_widget":"", "possible_target_widgets_typologies":[], "output_types": port_types[0], "output_id": 0, "type_others": {"other_html":"<div></div>"}}//ecc TODO based on other_html
    ];


    // Events!
    editor.on('nodeCreated', function (id) {
      let nodeBox = document.getElementById("node-"+id).childNodes[1];
      let widget_data = editor.getNodeFromId(id).data;
      let widget_name = "w_"+editor.getNodeFromId(id).class+"_node_"+id;
      widget_data["widget_name"]=widget_name;

      //Update node HTML
      if(widget_data["widget_type"] === "IN/OUT"){
        nodeBox.innerHTML += `
        <div class="box">
          <div class="separator">
            <label for="widgetname-`+id+`">WidgetName</label>
            <input id="widgetname-`+id+`" df-widget_name type="text" readonly></input>
          </div>
          <div id="ck-editor-`+id+`" class="ck-editor accordion accordion-flush">
            <div id="code-room-`+id+`" class="code-room">
              <label for="code-`+id+`">CK editor</label>
              <textarea id="code-`+id+`" df-code class="code-box"></textarea>
            </div>
            <div id="trigger-room-`+id+`" class="trigger-room"></div>
            <button onclick="addTrigger(`+id+`)" class="btn-add-trigger">add</button>
          </div>
        </div>
        `;
      } else if (widget_data["widget_type"] === "OUT"){
        nodeBox.innerHTML += `
        <div class="box">
          <div class="separator">
            <label for="widgetname-`+id+`">WidgetName</label>
            <input id="widgetname-`+id+`" df-widget_name type="text" readonly></input>
          </div>
          <div id="ck-editor-`+id+`" class="ck-editor accordion accordion-flush">
            <div id="trigger-room-`+id+`" class="trigger-room"></div>
            <button onclick="addTrigger(`+id+`)" class="btn-add-trigger">add</button>
          </div>
        </div>
        `;
      } else {
        nodeBox.innerHTML += `
        <div class="box">
          <div class="separator">
            <label for="widgetname-`+id+`">WidgetName</label>
            <input id="widgetname-`+id+`" df-widget_name type="text" readonly></input>
          </div>
        </div>
        `;
      }

      editor.updateNodeDataFromId(id,widget_data);
      updateHTMLFromNodeId(id);
      updateAllTriggersComposition(editor.getModuleFromNodeId(id), id ,"NodeCreated");

      console.log(editor);
      console.log("Node created " + id);
    })

    editor.on('nodeRemoved', function (id) {
      console.log("Node removed " + id);
      console.log(editor.getModuleFromNodeId(id));
      updateAllTriggersComposition("Home", id ,"NodeRemoved");
    })

    editor.on('nodeSelected', function (id) {
      console.log(editor.getNodeFromId(id));
    })

    editor.on('moduleCreated', function (name) {
      console.log("Module Created " + name);
    })

    editor.on('moduleChanged', function (name) {
      console.log("Module Changed " + name);
    })

    editor.on('connectionCreated', function (connection) {
      let output_node=editor.getNodeFromId(connection.output_id);
      let input_node=editor.getNodeFromId(connection.input_id);
      console.log(output_node.data.port_types[connection.output_class].type);
      if(output_node.data.port_types[connection.output_class].name != input_node.data.port_types[connection.input_class].name)
        editor.removeSingleConnection(connection.output_id, connection.input_id, connection.output_class, connection.input_class);
      console.log('Connection created');
      console.log(output_node);
      console.log(input_node);
      console.log(connection);
    })

    editor.on('connectionRemoved', function (connection) {
      console.log('Connection removed');
      console.log(connection);
    })
    /*
        editor.on('mouseMove', function(position) {
          console.log('Position mouse x:' + position.x + ' y:'+ position.y);
        })
    */
    editor.on('nodeMoved', function (id) {
      console.log("Node moved " + id);
    })

    editor.on('zoom', function (zoom) {
      console.log('Zoom level ' + zoom);
    })

    editor.on('translate', function (position) {
      console.log('Translate x:' + position.x + ' y:' + position.y);
    })

    editor.on('addReroute', function (id) {
      console.log("Reroute added " + id);
    })

    editor.on('removeReroute', function (id) {
      console.log("Reroute removed " + id);
    })
    /* DRAG EVENT */
    /* Mouse and Touch Actions */

    var elements = document.getElementsByClassName('drag-drawflow');
    for (var i = 0; i < elements.length; i++) {
      elements[i].addEventListener('touchend', drop, false);
      elements[i].addEventListener('touchmove', positionMobile, false);
      elements[i].addEventListener('touchstart', drag, false);
    }

    var mobile_item_selec = '';
    var mobile_last_move = null;
    function positionMobile(ev) {
      mobile_last_move = ev;
    }

    function allowDrop(ev) {
      ev.preventDefault();
    }

    function drag(ev) {
      if (ev.type === "touchstart") {
        mobile_item_selec = ev.target.closest(".drag-drawflow").getAttribute('data-node');
      } else {
        ev.dataTransfer.setData("node", ev.target.getAttribute('data-node'));
      }
    }

    function drop(ev) {
      if (ev.type === "touchend") {
        var parentdrawflow = document.elementFromPoint(mobile_last_move.touches[0].clientX, mobile_last_move.touches[0].clientY).closest("#drawflow");
        if (parentdrawflow != null) {
          addNodeToDrawFlow(mobile_item_selec, mobile_last_move.touches[0].clientX, mobile_last_move.touches[0].clientY);
        }
        mobile_item_selec = '';
      } else {
        ev.preventDefault();
        var data = ev.dataTransfer.getData("node");
        addNodeToDrawFlow(data, ev.clientX, ev.clientY);
      }

    }
    
    function addTrigger(id){
      let node = editor.getNodeFromId(id);
      let triggerRoom = document.getElementById("trigger-room-"+id);
      let trigger_id = node.data.trigger_number;
      let trigger_name = "trigger_"+trigger_id;
      let trigger=trigger_types[0];
      trigger.id=trigger_id;

      //Add a new trigger to node.data.triggers
      node.data.trigger_number +=1;
      node.data.triggers[trigger_name] = trigger;
      editor.updateNodeDataFromId(id,node.data);

      //Modify node HTML with a new trigger form
      triggerRoom.insertAdjacentHTML("beforeend",`
      <div class="trigger-box accordion-item" id="trigger-box-`+id+"-"+trigger_id+`">
        <div class="accordion-header">
          <button class="accordion-button" type="button" data-bs-toggle="collapse" data-bs-target="#collapse`+id+"-"+trigger_id+`" aria-expanded="true" aria-controls="collapse`+id+"-"+trigger_id+`">
            trigger-box-`+id+"-"+trigger_id+`
          </button>
        </div>
        <div id="collapse`+id+"-"+trigger_id+`" class="accordion-collapse collapse show" data-bs-parent="#trigger-room-`+id+`">
          <div class="accordion-body">
            <div class="separator">
              <label for="type-`+id+"-"+trigger_id+`">Type</label>
              <select onchange="changeTriggerComposition(`+id+`,`+trigger_id+`)" id="type-`+id+"-"+trigger_id+`" df-triggers-`+trigger_name+`-type type="text" class="trigger-box-type-input"></select>
            </div>
            <div class="separator">
              <label for="targetwidget-`+id+"-"+trigger_id+`">TargetWidget</label>
              <select id="targetwidget-`+id+"-"+trigger_id+`" df-triggers-`+trigger_name+`-target_widget type="text" class="trigger-box-targetwidget-input"></select>
            </div>
            <div class="separator" id="other-html-`+id+"-"+trigger_id+`">
            </div>
            <button onclick="deleteTrigger(`+id+`,`+trigger_id+`)" class="btn-delete-trigger">delete</button>
          </div>
        </div>
      </div>
      `);

      //take trigger type list based on widget type (ex. RadarSeries have a trigger type list he can perform, TimeTrend have another trigger type list he can perform, ecc..)
      let type_trigger= document.getElementById("type-"+id+"-"+trigger_id);
      for(let i=0; i< trigger_types.length;i++){
        if(trigger_types[i].widgets_typologies_which_can_perform_it.includes(node.name))
          type_trigger.insertAdjacentHTML("beforeend",`<option value="`+i+`">`+trigger_types[i].type+`</option>`);
      }

      changeTriggerComposition(id,trigger_id);
      editor.updateNodeDataFromId(id,node.data);
      updateHTMLFromNodeId(id);

      console.log(editor.getNodeFromId(id));
    }

    function deleteTrigger(id,trigger_id){
      let triggerRoom = document.getElementById("trigger-box-"+id+"-"+trigger_id);
      let node=editor.getNodeFromId(id);

      //Delete a trigger from node.data.triggers
      delete node.data.triggers["trigger_"+trigger_id];
      editor.updateNodeDataFromId(id,node.data);

      //Remove node HTML of a trigger
      triggerRoom.remove();
      updateHTMLFromNodeId(id);

      console.log(editor.getNodeFromId(id));
    }

    function updateHTMLFromNodeId(id){
      let module = editor.getModuleFromNodeId(id);
      let nodeContent = document.getElementById("node-"+id).childNodes[1];
      editor.drawflow.drawflow[module].data[id].html = nodeContent.innerHTML;
    }

    function updateOtherHTMLTriggerComposition(id,trigger_id){
      let other_html = document.getElementById("other-html-"+id+"-"+trigger_id);
      other_html.innerHTML = editor.getNodeFromId(id).data.triggers["trigger_"+trigger_id].type_others.other_html;
      updateHTMLFromNodeId(id);
    }

    function changeTriggerComposition(id,trigger_id){
      let target_widget_trigger = document.getElementById("targetwidget-"+id+"-"+trigger_id);
      target_widget_trigger.innerHTML = `<option value="" selected></option>`;
      let type_trigger_id = document.getElementById("type-"+id+"-"+trigger_id).value;
      let module = editor.getModuleFromNodeId(id);
      Object.keys(editor.drawflow.drawflow[module].data).forEach(id =>
      { 
        if(trigger_types[type_trigger_id].possible_target_widgets_typologies.includes(editor.drawflow.drawflow[module].data[id].name))
          target_widget_trigger.insertAdjacentHTML("beforeend",`<option value="`+id+`">`+editor.getNodeFromId(id).data["widget_name"]+`</option>`);
      });
      updateOtherHTMLTriggerComposition(id,trigger_id);
      updateHTMLFromNodeId(id);
    }

    function updateAllTriggersComposition(module, update_id ,action){
      Object.keys(editor.drawflow.drawflow[module].data).forEach(id =>
        {
          if("triggers" in editor.drawflow.drawflow[module].data[id].data){
            let trigger_id , target_widget_trigger;
            if(action==="NodeCreated"){
              Object.keys(editor.getNodeFromId(id).data.triggers).forEach(trigger_name => {
                trigger_id=editor.getNodeFromId(id).data.triggers[trigger_name].id;
                target_widget_trigger = document.getElementById("targetwidget-"+id+"-"+trigger_id);
                target_widget_trigger.insertAdjacentHTML("beforeend",`<option value="`+update_id+`">`+editor.getNodeFromId(update_id).data["widget_name"]+`</option>`);
              })
            }else if(action==="NodeRemoved"){
              Object.keys(editor.getNodeFromId(id).data.triggers).forEach(trigger_name => {
                trigger_id=editor.getNodeFromId(id).data.triggers[trigger_name].id;
                target_widget_trigger = document.getElementById("targetwidget-"+id+"-"+trigger_id);
                for (var i=0; i<target_widget_trigger.length; i++) {
                  if (target_widget_trigger.options[i].value === update_id)
                      target_widget_trigger.remove(i);
                }
              })
            }
            updateHTMLFromNodeId(id);
          }
        }
      );
    }

    function addNodeToDrawFlow(name, pos_x, pos_y) {
      if (editor.editor_mode === 'fixed') {
        return false;
      }
      pos_x = pos_x * (editor.precanvas.clientWidth / (editor.precanvas.clientWidth * editor.zoom)) - (editor.precanvas.getBoundingClientRect().x * (editor.precanvas.clientWidth / (editor.precanvas.clientWidth * editor.zoom)));
      pos_y = pos_y * (editor.precanvas.clientHeight / (editor.precanvas.clientHeight * editor.zoom)) - (editor.precanvas.getBoundingClientRect().y * (editor.precanvas.clientHeight / (editor.precanvas.clientHeight * editor.zoom)));

      switch (name) {
        case 'RadarSeries':
          var radarSeries = `
            <div class="title-box"><i class="fas fa-code"></i> RadarSeries</div>
          `;
          var data = {"widget_type":"IN/OUT", "widget_name":"", "code":"" ,"port_types":{"input_1":port_types[1],"input_2" : port_types[4],"output_1":port_types[3],"output_2" : port_types[4]}, "trigger_number": 0, "triggers":{}};
          editor.addNode('RadarSeries', 2, 2, pos_x, pos_y, 'radarseries', data, radarSeries);
          break;

        case 'TimeTrend':
          var timeTrend = `
            <div class="title-box"><i class="fas fa-code"></i> TimeTrend</div>
          `;
          var data = {"widget_type":"IN/OUT", "widget_name":"", "code":"" ,"port_types":{"input_1":port_types[1],"input_2" : port_types[4],"output_1":port_types[3],"output_2" : port_types[4]}, "trigger_number": 0, "triggers":{}};
          editor.addNode('TimeTrend', 1, 3, pos_x, pos_y, 'timetrend', data, timeTrend);
          break;

        case 'CurvedLineSeries':
          var curvedLineSeries = `
            <div class="title-box"><i class="fas fa-code"></i> CurvedLineSeries</div>
          `;
          var data = {"widget_type":"IN/OUT", "widget_name":"", "code":"" ,"port_types":{"input_1":port_types[1],"input_2" : port_types[4],"output_1":port_types[3],"output_2" : port_types[4]}, "trigger_number": 0, "triggers":{}};
          editor.addNode('CurvedLineSeries', 3, 4, pos_x, pos_y, 'curvedlineseries', data, curvedLineSeries);
          break;

        case 'PieChart':
          var pieChart = `
            <div class="title-box"><i class="fas fa-code"></i> PieChart</div>
          `;
          var data = { "port_types":{"input_1":port_types[0],"input_2" : port_types[1],"output_1":port_types[0],"output_2" : port_types[1]}};
          editor.addNode('PieChart', 2, 2, pos_x, pos_y, 'piechart', data, pieChart);
          break;

        case 'BarSeries':
          var barSeries = `
            <div class="title-box"><i class="fas fa-code"></i> BarSeries</div>
          `;
          var data = { "port_types":{"input_1":port_types[0],"input_2" : port_types[1],"output_1":port_types[0],"output_2" : port_types[1]}};
          editor.addNode('BarSeries', 2, 2, pos_x, pos_y, 'barseries', data, barSeries);
          break;

        case 'Map':
          var map = `
            <div class="title-box"><i class="fas fa-code"></i> Map</div>
          `;
          var data = { "port_types":{"input_1":port_types[0],"input_2" : port_types[1],"output_1":port_types[0],"output_2" : port_types[1]}};
          editor.addNode('Map', 2, 2, pos_x, pos_y, 'map', data, map);
          break;

        case 'Speedometer':
          var speedometer = `
            <div class="title-box"><i class="fas fa-code"></i> Speedometer</div>
          `;
          var data = { "port_types":{"input_1":port_types[0],"input_2" : port_types[1],"output_1":port_types[0],"output_2" : port_types[1]}};
          editor.addNode('Speedometer', 2, 2, pos_x, pos_y, 'speedometer', data, speedometer);
          break;

        case 'GaugeChart':
          var gaugeChart = `
            <div class="title-box"><i class="fas fa-code"></i> GaugeChart</div>
          `;
          var data = { "port_types":{"input_1":port_types[0],"input_2" : port_types[1],"output_1":port_types[0],"output_2" : port_types[1]}};
          editor.addNode('GaugeChart', 2, 2, pos_x, pos_y, 'gaugechart', data, gaugeChart);
          break;

        case 'Knob':
          var knob = `
            <div class="title-box"><i class="fas fa-code"></i> Knob</div>
          `;
          var data = { "port_types":{"input_1":port_types[0],"input_2" : port_types[1],"output_1":port_types[0],"output_2" : port_types[1]}};
          editor.addNode('Knob', 2, 2, pos_x, pos_y, 'knob', data, knob);
          break;

        case 'NumericKeyboard':
          var numericKeyboard = `
            <div class="title-box"><i class="fas fa-code"></i> NumericKeyboard</div>
          `;
          var data = { "port_types":{"input_1":port_types[0],"input_2" : port_types[1],"output_1":port_types[0],"output_2" : port_types[1]}};
          editor.addNode('NumericKeyboard', 2, 2, pos_x, pos_y, 'numerickeyboard', data, numericKeyboard);
          break;

        case 'SingleContent':
          var singleContent = `
            <div class="title-box"><i class="fas fa-code"></i> SingleContent</div>
          `;
          var data = { "port_types":{"input_1":port_types[0],"input_2" : port_types[1],"output_1":port_types[0],"output_2" : port_types[1]}};
          editor.addNode('SingleContent', 2, 2, pos_x, pos_y, 'singlecontent', data, singleContent);
          break;

        case 'ExternalContent':
          var externalContent = `
            <div class="title-box"><i class="fas fa-code"></i> ExternalContent</div>
          `;
          var data = { "port_types":{"input_1":port_types[0],"input_2" : port_types[1],"output_1":port_types[0],"output_2" : port_types[1]}};
          editor.addNode('ExternalContent', 2, 2, pos_x, pos_y, 'externalcontent', data, externalContent);
          break;

        case 'Table':
          var table = `
            <div class="title-box"><i class="fas fa-code"></i> Table</div>
          `;
          var data = { "port_types":{"input_1":port_types[0],"input_2" : port_types[1],"output_1":port_types[0],"output_2" : port_types[1]}};
          editor.addNode('Table', 2, 2, pos_x, pos_y, 'table', data, table);
          break;

        case 'DeviceTable':
          var deviceTable = `
            <div class="title-box"><i class="fas fa-code"></i> DeviceTable</div>
          `;
          var data = { "port_types":{"input_1":port_types[0],"input_2" : port_types[1],"output_1":port_types[0],"output_2" : port_types[1]}};
          editor.addNode('DeviceTable', 2, 2, pos_x, pos_y, 'devicetable', data, deviceTable);
          break;

        case 'EventTable':
          var eventTable = `
            <div class="title-box"><i class="fas fa-code"></i> EventTable</div>
          `;
          var data = { "port_types":{"input_1":port_types[0],"input_2" : port_types[1],"output_1":port_types[0],"output_2" : port_types[1]}};
          editor.addNode('EventTable', 2, 2, pos_x, pos_y, 'eventtable', data, eventTable);
          break;

        case 'Button':
          var button = `
            <div class="title-box"><i class="fas fa-code"></i> Button</div>
          `;
          var data = { "port_types":{"input_1":port_types[0],"input_2" : port_types[1],"output_1":port_types[0],"output_2" : port_types[1]}};
          editor.addNode('Button', 2, 2, pos_x, pos_y, 'button', data, button);
          break;

        case 'OnOffButton':
          var onOffButton = `
            <div class="title-box"><i class="fas fa-code"></i> OnOffButton</div>
          `;
          var data = { "port_types":{"input_1":port_types[0],"input_2" : port_types[1],"output_1":port_types[0],"output_2" : port_types[1]}};
          editor.addNode('OnOffButton', 2, 2, pos_x, pos_y, 'onoffbutton', data, onOffButton);
          break;

        case 'ImpulseButton':
          var impulseButton = `
            <div class="title-box"><i class="fas fa-code"></i> ImpulseButton</div>
          `;
          var data = { "port_types":{"input_1":port_types[0],"input_2" : port_types[1],"output_1":port_types[0],"output_2" : port_types[1]}};
          editor.addNode('ImpulseButton', 2, 2, pos_x, pos_y, 'impulsebutton', data, impulseButton);
          break;

        default:
      }
    }
    function verifyConnection(){

    }
    var transform = '';
    function showpopup(e) {
      e.target.closest(".drawflow-node").style.zIndex = "9999";
      e.target.children[0].style.display = "block";
      //document.getElementById("modalfix").style.display = "block";

      //e.target.children[0].style.transform = 'translate('+translate.x+'px, '+translate.y+'px)';
      transform = editor.precanvas.style.transform;
      editor.precanvas.style.transform = '';
      editor.precanvas.style.left = editor.canvas_x + 'px';
      editor.precanvas.style.top = editor.canvas_y + 'px';
      console.log(transform);

      //e.target.children[0].style.top  =  -editor.canvas_y - editor.container.offsetTop +'px';
      //e.target.children[0].style.left  =  -editor.canvas_x  - editor.container.offsetLeft +'px';
      editor.editor_mode = "fixed";

    }

    function closemodal(e) {
      e.target.closest(".drawflow-node").style.zIndex = "2";
      e.target.parentElement.parentElement.style.display = "none";
      //document.getElementById("modalfix").style.display = "none";
      editor.precanvas.style.transform = transform;
      editor.precanvas.style.left = '0px';
      editor.precanvas.style.top = '0px';
      editor.editor_mode = "edit";
    }

    function changeMode(option) {

      //console.log(lock.id);
      if (option == 'lock') {
        lock.style.display = 'none';
        unlock.style.display = 'block';
      } else {
        lock.style.display = 'block';
        unlock.style.display = 'none';
      }

    }

  </script>
</body>

</html>